# 企业级Openwrt配置

> > 满足跨境电商的tk等设备一机一网的需求
>
> 基本需求:正常的pppoe拨号,以及dhcp服务器配置,包括对网段的划分
>
> 进阶需求:
>
> 1. 使用openvpn对该代理的设备做出代理,不需要代理的设备保持直连
> 2. 使用passwall做分流,实现一机一网,并且,一机一网的情况下前置代理是openvpn
> 3. ...

## 基本需求

基础配置:

### 设置pppoe拨号

![image-20250730110606549](./image-20250730110606549.png)


### lan的设计

恢复原先ikuai的网关,和dhcp分配

![](./Snipaste_2025-07-30_11-08-01.png)

### 设置dhcp

> 启动: 192.168.16.1
>
> 客户数: 720
>
> 因为是主机只有748,除去广播255和网关1,剩下的做保留地址

### 静态ip设置

![image-20250730111114009](./image-20250730111114009.png)

### 设置端口转发

![image-20250730111309945](./image-20250730111309945.png)

以上,可以正常使用

## 进阶需求

### openvpn的配置

首先**必须**有一个.ovpn的配置文件

到软件包下载**openvpn**和依赖包**openssl**

添加一个实例

```text
client // 客户端
dev tun // 打开tun虚拟网卡
proto udp // 代理模式UDP / 根据需要换TCP
remote xxx.xxx.xxx.xxxx 1194 // 主机的IP或者域名 端口直接空格
resolv-retry infinite // 无限失败重试
nobind // 不用绑定
persist-key
persist-tun
remote-cert-tls server // 无需tls
auth SHA512 // 加密方式
ignore-unknown-option block-outside-dns
verb 3
pull-filter ignore redirect-gateway // 阻止服务端下发路由

<cert>
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN=Easy-RSA CA
        Validity
            Not Before: Jul 28 11:50:46 2025 GMT
            Not After : Jul 26 11:50:46 2035 GMT
        Subject: CN=client
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Basic Constraints: 
                CA:FALSE
            X509v3 Subject Key Identifier: 
                
            X509v3 Authority Key Identifier: 
               
                DirName:/CN=Easy-RSA CA
                
            X509v3 Extended Key Usage: 
                TLS Web Client Authentication
            X509v3 Key Usage: 
                Digital Signature
    Signature Algorithm: sha256WithRSAEncryption
    Signature Value:
        
-----BEGIN CERTIFICATE-----

-----END CERTIFICATE-----
</cert>

<key>
-----BEGIN PRIVATE KEY-----

-----END PRIVATE KEY-----
</key>

<ca>
-----BEGIN CERTIFICATE-----

-----END CERTIFICATE-----
</ca>

<tls-crypt>
-----BEGIN OpenVPN Static key V1-----

-----END OpenVPN Static key V1-----
</tls-crypt>
```

以上是基础框架,如果遇到没有提供`.ovpn`的,可以使用

然后在我们的`网络>接口`里面

新增一个接口

![image-20250730112549276](./image-20250730112549276.png)

![image-20250730112602913](./image-20250730112602913.png)

![image-20250730112630436](./image-20250730112630436.png)

![image-20250730112642456](./image-20250730112642456.png)

这下实现全局的流量走了openvpn

```shell
ip route // 查看路由表
ip rule show // 查看当前规则
ip rule add from xxx.xxx.xxx.xxx table 100 // 增加一条规则
ip route add default dev tun0 table 100 // 增加一个路由规则
ip route get 8.8.8.8 from xxx.xxx.xxx.xxx iif br-lan // 测试数据包是否走tun接口
ip route flush cache // 清空缓存
```

走策略路由可以指定某个主机或者网段走openvpn,其他的直连

### Passwall分流

> 其实很建议直接使用passwall来做分流和前置代理
>
> 首先
>
> - 恢复passwall的初始设置
>
> 然后
>
> ![image-20250730141851015](./image-20250730141851015.png)
>
> ![image-20250730141939529](./image-20250730141939529.png)
>
> ![image-20250730141950121](./image-20250730141950121.png)
>
> ![image-20250730142210905](./image-20250730142210905.png)
>
> ![image-20250730142249181](./image-20250730142249181.png)
>
> ![image-20250730142303404](./image-20250730142303404.png)
>
> ![image-20250730142315186](./image-20250730142315186.png)

## 接口文档

## 登录

> 接口地址:`/cgi-bin/luci/`
>
> 方法:`POST`
>
> 请求标头:`x-www-form-urlencoded`
>
> 传递参数:`luci_username=root&luci_password=`
>
> 响应参数:
>
> ```text
> 传递的token附在cookies上
> key | value
> sysauth_http | xxx
> ```
>
> 

### 创建Passwall规则

> **有CSRF防护**
>
> 必须通过这个
>
> 接口:`/cgi-bin/luci/admin/services/passwall/rule`
>
> 方法:`POST`
>
> 请求标头:`cookie: sysauth_http=feed7e1fe1854174a7e64f165d5a3124; username=admin; login=1`
>
> 返回了一个:`token:f7dcaf61d33a62ac5ba3c97ca08a11d0`



> 先添加一个有名的规则,不写数据
>
> 接口地址:`/cgi-bin/luci/admin/services/passwall/shunt_rules/[规则名]`
>
> 方法:`GET`
>
> 请求标头:`cookie: sysauth_http=feed7e1fe1854174a7e64f165d5a3124; username=admin; login=1`

然后

> "接口地址":`/cgi-bin/luci/admin/services/passwall/shunt_rules/[这个是规则名]`
>
> 方法:`POST`
>
> 请求标头: `multipart/form-data`
>
> 认证字段:
>
> ```json
> {
>     "token": "LuCI 会话 Token，防止 CSRF 攻击。",
>     "cbi.submit": "1" 1表示提交表单
> }
> ```
>
> 必须传递参数:
>
> ```json
> key | value | remark
> cbid.passwall.fenliu_test.remarks | [text] | 该分流规则的备注名称
> cbid.passwall.fenliu_test.source | [text] | 只能一个值,就是某个ip,这个是一机一网的关键
> cbid.passwall.fenliu_test.ip_list | [text] | 必须是:'0.0.0.0/0'
> ```
>

> 通过接口的方式不现实,准备采用读取`passwall`的配置文件的方式,通过脚本批量写入的方式,来实现一机一网

### SSH方式读取配置文件

```bash
cat /etc/config/passwall
```

可以读取到配置文件

```text
config global
        option enabled '1'
        option socks_enabled '0'
        option filter_proxy_ipv6 '1'
        option dns_shunt 'dnsmasq'
        option dns_mode 'tcp'
        option remote_dns '8.8.8.8'
        list smartdns_remote_dns 'https://1.1.1.1/dns-query'
        option dns_redirect '0'
        option chn_list '0'
        option tcp_proxy_mode 'proxy'
        option udp_proxy_mode 'proxy'
        option localhost_proxy '1'
        option client_proxy '1'
        option acl_enable '0'
        option log_tcp '1'
        option log_udp '0'
        option loglevel 'error'
        option trojan_loglevel '4'
        option log_chinadns_ng '0'
        option tcp_node 'UbdghGyO'
        option udp_node 'tcp'
        option tcp_node_socks_port '1070'
        option v2ray_dns_mode 'tcp'
        option use_direct_list '0'
        option use_proxy_list '0'
        option use_block_list '0'
        option use_gfw_list '0'
        option dnsmasq_dns_redirect '1'

config global_haproxy
        option balancing_enable '0'

config global_delay
        option start_daemon '1'
        option start_delay '10'

config global_forwarding
        option tcp_no_redir_ports 'disable'
        option udp_no_redir_ports 'disable'
        option tcp_proxy_drop_ports 'disable'
        option udp_proxy_drop_ports '443'
        option tcp_redir_ports '22,25,53,143,465,587,853,993,995,80,443'
        option udp_redir_ports '1:65535'
        option accept_icmp '0'
        option use_nft '1'
        option tcp_proxy_way 'redirect'
        option ipv6_tproxy '0'

config global_xray
        option sniffing_override_dest '0'
        option fragment '0'
        option noise '0'

config global_singbox
        option sniff_override_destination '0'

config global_other
        option auto_detection_time 'tcping'
        option show_node_info '1'

config global_rules
        option auto_update '1'
        option chnlist_update '1'
        option chnroute_update '1'
        option chnroute6_update '1'
        option gfwlist_update '1'
        option geosite_update '1'
        option geoip_update '1'
        list gfwlist_url 'https://fastly.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/gfw.txt'
        list chnroute_url 'https://ispip.clang.cn/all_cn.txt'
        list chnroute_url 'https://fastly.jsdelivr.net/gh/gaoyifan/china-operator-ip@ip-lists/china.txt'
        list chnroute6_url 'https://ispip.clang.cn/all_cn_ipv6.txt'
        list chnroute6_url 'https://fastly.jsdelivr.net/gh/gaoyifan/china-operator-ip@ip-lists/china6.txt'
        list chnlist_url 'https://fastly.jsdelivr.net/gh/felixonmars/dnsmasq-china-list/accelerated-domains.china.conf'
        list chnlist_url 'https://fastly.jsdelivr.net/gh/felixonmars/dnsmasq-china-list/apple.china.conf'
        option v2ray_location_asset '/usr/share/v2ray/'
        option geoip_url 'https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat'
        option geosite_url 'https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geosite.dat'
        option week_update '7'
        option time_update '6'
        option enable_geoview '0'

config global_app
        option sing_box_file '/usr/bin/sing-box'
        option xray_file '/usr/bin/xray'
        option hysteria_file '/usr/bin/hysteria'

config global_subscribe
        option filter_keyword_mode '1'
        list filter_discard_list '距离下次重置剩余'
        list filter_discard_list '套餐到期'
        list filter_discard_list '过期时间'
        list filter_discard_list '剩余流量'
        list filter_discard_list 'QQ群'
        list filter_discard_list '官网'

config shunt_rules 'DirectGame'
        option remarks 'DirectGame'
        option domain_list '# steam直连域名获取国内CDN走国内线路下载
cm.steampowered.com
steamserver.net

# steam国内CDN华为云
steampipe.steamcontent.tnkjmec.com
# steam国内CDN白山云
st.dl.eccdnx.com
st.dl.bscstorage.net
st.dl.pinyuncloud.com
# steam国内CDN新流云(原金山云)(支持ipv6)
dl.steam.clngaa.com
# steam国内CDN网宿
cdn.mileweb.cs.steampowered.com.8686c.com
cdn-ws.content.steamchina.com
# steam国内CDN腾讯云 (蒸汽中国独占)
cdn-qc.content.steamchina.com
# steam国内CDN阿里云(支持ipv6)
cdn-ali.content.steamchina.com
xz.pphimalayanrt.com
lv.queniujq.cn
alibaba.cdn.steampipe.steamcontent.com

# 国内游戏geosite域名
geosite:category-games@cn'
        option ip_list '# steam直连IP
45.121.184.0/24
103.10.124.0/23
103.28.54.0/24
146.66.152.0/24
146.66.155.0/24
153.254.86.0/24
155.133.224.0/22
155.133.230.0/24
155.133.232.0/23
155.133.234.0/24
155.133.236.0/22
155.133.240.0/23
155.133.244.0/23
155.133.246.0/24
155.133.248.0/21
162.254.192.0/21
185.25.182.0/23
190.217.32.0/22
192.69.96.0/22
205.196.6.0/24
208.64.200.0/22
208.78.164.0/22
205.185.194.0/24'

config shunt_rules 'ProxyGame'
        option remarks 'ProxyGame'
        option domain_list '# steam 商店/客服/聊天/网页布局/API/二维码/Google云同步 代理URL
steamcommunity.com
www.steamcommunity.com
store.steampowered.com
checkout.steampowered.com
api.steampowered.com
help.steampowered.com
login.steampowered.com
store.akamai.steamstatic.com
steambroadcast.akamaized.net
steamvideo-a.akamaihd.net
steamusercontent-a.akamaihd.net
steamstore-a.akamaihd.net
steamcommunity-a.akamaihd.net
steamcdn-a.akamaihd.net
steamuserimages-a.akamaihd.net
community.akamai.steamstatic.com
avatars.akamai.steamstatic.com
community.steamstatic.com
cdn.akamai.steamstatic.com
avatars.steamstatic.com
shared.akamai.steamstatic.com
clan.akamai.steamstatic.com
cdn.cloudflare.steamstatic.com
community.cloudflare.steamstatic.com
store.cloudflare.steamstatic.com
avatars.cloudflare.steamstatic.com
clan.cloudflare.steamstatic.com
shared.cloudflare.steamstatic.com
steam-chat.com
steamcloud-ugc.storage.googleapis.com
steamcloud-eu-ams.storage.googleapis.com
steamcloud-eu-fra.storage.googleapis.com
steamcloud-finland.storage.googleapis.com
steamcloud-saopaulo.storage.googleapis.com
steamcloud-singapore.storage.googleapis.com
steamcloud-sydney.storage.googleapis.com
steamcloud-taiwan.storage.googleapis.com
steamcloud-eu.storage.googleapis.com

geosite:category-games'

config shunt_rules 'AIGC'
        option remarks 'AIGC'
        option domain_list 'geosite:category-ai-!cn
geosite:apple-intelligence'

config shunt_rules 'Streaming'
        option remarks 'Streaming'
        option domain_list 'geosite:netflix
geosite:disney'

config shunt_rules 'Proxy'
        option remarks 'Proxy'
        option domain_list 'geosite:geolocation-!cn'
        option ip_list '149.154.160.0/20
91.108.4.0/22
91.108.56.0/24
109.239.140.0/24
67.198.55.0/24
8.8.4.4
8.8.8.8
208.67.222.222
208.67.220.220
1.1.1.1
1.1.1.2
1.0.0.1
9.9.9.9
149.112.112.112
2001:67c:4e8::/48
2001:b28:f23c::/48
2001:b28:f23d::/48
2001:b28:f23f::/48
2001:b28:f242::/48
2001:4860:4860::8888
2001:4860:4860::8844
2606:4700:4700::1111
2606:4700:4700::1001'

config shunt_rules 'Direct'
        option remarks 'Direct'
        option domain_list 'geosite:cn'
        option ip_list '223.5.5.5/32
223.6.6.6/32
119.29.29.29/32
180.76.76.76/32
114.114.114.114/32
114.114.115.115/32
1.12.12.12/32
120.53.53.53/32
geoip:cn
geoip:private'

config nodes 'Dah2TR22'
        option remarks '备注'
        option type 'Xray'
        option protocol 'trojan'
        option address '43.199.249.147'
        option port '57037'
        option password 'elrwin84p6'
        option tls '0'
        option transport 'raw'
        option tcp_guise 'none'
        option tcpMptcp '0'
        option tcpNoDelay '0'

config shunt_rules 'fenliutest'
        option remarks 'fenliutest'
        option network 'tcp,udp'
        option ip_list '0.0.0.0/0'
        option source '192.168.10.49'

config nodes 'UbdghGyO'
        option remarks 'test分流'
        option type 'Xray'
        option protocol '_shunt'
        option default_node '_direct'
        option domainStrategy 'IPOnDemand'
        option domainMatcher 'hybrid'
        option preproxy_enabled '1'
        option main_node 'QQfJTX6h'
        option fenliutest 'Dah2TR22'
        option fenliutest_proxy_tag 'main'
        option fenliu_yunji 'QQfJTX6h'

config nodes 'QQfJTX6h'
        option tls '0'
        option type 'Xray'
        option timeout '60'
        option tcp_guise 'none'
        option security 'auto'
        option transport 'raw'
        option add_from '导入'
        option port '31121'
        option uuid '12ba3dab-b32c-4ebf-9a46-c00c93d86d25'
        option address '54.46.84.41'
        option remarks 'HK前置代理节点-test'
        option protocol 'vmess'
        option alter_id '0'
        option add_mode '1'
        option tcpMptcp '0'
        option tcpNoDelay '0'

config shunt_rules 'fenliu_yunji'
        option remarks 'fenliu_yunji'
        option network 'tcp,udp'
        option source '192.168.10.42 192.168.10.43 192.168.10.44 192.168.10.45 192.168.10.46 192.168.10.47 192.168.10.48 192.168.10.50 192.168.10.51 192.168.10.52 192.168.10.53 192.168.10.54 192.168.10.55 192.168.10.56 192.168.10.57 192.168.10.58 192.168.10.60 192.168.10.61 192.168.10.62 192.168.10.63 192.168.10.64 192.168.10.65 192.168.10.66 192.168.10.67 192.168.10.68 192.168.10.69 192.168.10.70 192.168.10.71 192.168.10.72 192.168.10.73 192.168.10.74'
        option ip_list '0.0.0.0/0'

root@ImmortalWrt:~# vi /etc/config/passwall
root@ImmortalWrt:~# vi /etc/config/passwall
root@ImmortalWrt:~# cat /etc/config/passwall

config global
        option enabled '1'
        option socks_enabled '0'
        option filter_proxy_ipv6 '1'
        option dns_shunt 'dnsmasq'
        option dns_mode 'tcp'
        option remote_dns '8.8.8.8'
        list smartdns_remote_dns 'https://1.1.1.1/dns-query'
        option dns_redirect '0'
        option chn_list '0'
        option tcp_proxy_mode 'proxy'
        option udp_proxy_mode 'proxy'
        option localhost_proxy '1'
        option client_proxy '1'
        option acl_enable '0'
        option log_tcp '1'
        option log_udp '0'
        option loglevel 'error'
        option trojan_loglevel '4'
        option log_chinadns_ng '0'
        option tcp_node 'UbdghGyO'
        option udp_node 'tcp'
        option tcp_node_socks_port '1070'
        option v2ray_dns_mode 'tcp'
        option use_direct_list '0'
        option use_proxy_list '0'
        option use_block_list '0'
        option use_gfw_list '0'
        option dnsmasq_dns_redirect '1'

config global_haproxy
        option balancing_enable '0'

config global_delay
        option start_daemon '1'
        option start_delay '10'

config global_forwarding
        option tcp_no_redir_ports 'disable'
        option udp_no_redir_ports 'disable'
        option tcp_proxy_drop_ports 'disable'
        option udp_proxy_drop_ports '443'
        option tcp_redir_ports '22,25,53,143,465,587,853,993,995,80,443'
        option udp_redir_ports '1:65535'
        option accept_icmp '0'
        option use_nft '1'
        option tcp_proxy_way 'redirect'
        option ipv6_tproxy '0'

config global_xray
        option sniffing_override_dest '0'
        option fragment '0'
        option noise '0'

config global_singbox
        option sniff_override_destination '0'

config global_other
        option auto_detection_time 'tcping'
        option show_node_info '1'

config global_rules
        option auto_update '1'
        option chnlist_update '1'
        option chnroute_update '1'
        option chnroute6_update '1'
        option gfwlist_update '1'
        option geosite_update '1'
        option geoip_update '1'
        list gfwlist_url 'https://fastly.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/gfw.txt'
        list chnroute_url 'https://ispip.clang.cn/all_cn.txt'
        list chnroute_url 'https://fastly.jsdelivr.net/gh/gaoyifan/china-operator-ip@ip-lists/china.txt'
        list chnroute6_url 'https://ispip.clang.cn/all_cn_ipv6.txt'
        list chnroute6_url 'https://fastly.jsdelivr.net/gh/gaoyifan/china-operator-ip@ip-lists/china6.txt'
        list chnlist_url 'https://fastly.jsdelivr.net/gh/felixonmars/dnsmasq-china-list/accelerated-domains.china.conf'
        list chnlist_url 'https://fastly.jsdelivr.net/gh/felixonmars/dnsmasq-china-list/apple.china.conf'
        option v2ray_location_asset '/usr/share/v2ray/'
        option geoip_url 'https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat'
        option geosite_url 'https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geosite.dat'
        option week_update '7'
        option time_update '6'
        option enable_geoview '0'

config global_app
        option sing_box_file '/usr/bin/sing-box'
        option xray_file '/usr/bin/xray'
        option hysteria_file '/usr/bin/hysteria'

config global_subscribe
        option filter_keyword_mode '1'
        list filter_discard_list '距离下次重置剩余'
        list filter_discard_list '套餐到期'
        list filter_discard_list '过期时间'
        list filter_discard_list '剩余流量'
        list filter_discard_list 'QQ群'
        list filter_discard_list '官网'

config shunt_rules 'DirectGame'
        option remarks 'DirectGame'
        option domain_list '# steam直连域名获取国内CDN走国内线路下载
cm.steampowered.com
steamserver.net

# steam国内CDN华为云
steampipe.steamcontent.tnkjmec.com
# steam国内CDN白山云
st.dl.eccdnx.com
st.dl.bscstorage.net
st.dl.pinyuncloud.com
# steam国内CDN新流云(原金山云)(支持ipv6)
dl.steam.clngaa.com
# steam国内CDN网宿
cdn.mileweb.cs.steampowered.com.8686c.com
cdn-ws.content.steamchina.com
# steam国内CDN腾讯云 (蒸汽中国独占)
cdn-qc.content.steamchina.com
# steam国内CDN阿里云(支持ipv6)
cdn-ali.content.steamchina.com
xz.pphimalayanrt.com
lv.queniujq.cn
alibaba.cdn.steampipe.steamcontent.com

# 国内游戏geosite域名
geosite:category-games@cn'
        option ip_list '# steam直连IP
45.121.184.0/24
103.10.124.0/23
103.28.54.0/24
146.66.152.0/24
146.66.155.0/24
153.254.86.0/24
155.133.224.0/22
155.133.230.0/24
155.133.232.0/23
155.133.234.0/24
155.133.236.0/22
155.133.240.0/23
155.133.244.0/23
155.133.246.0/24
155.133.248.0/21
162.254.192.0/21
185.25.182.0/23
190.217.32.0/22
192.69.96.0/22
205.196.6.0/24
208.64.200.0/22
208.78.164.0/22
205.185.194.0/24'

config shunt_rules 'ProxyGame'
        option remarks 'ProxyGame'
        option domain_list '# steam 商店/客服/聊天/网页布局/API/二维码/Google云同步 代理URL
steamcommunity.com
www.steamcommunity.com
store.steampowered.com
checkout.steampowered.com
api.steampowered.com
help.steampowered.com
login.steampowered.com
store.akamai.steamstatic.com
steambroadcast.akamaized.net
steamvideo-a.akamaihd.net
steamusercontent-a.akamaihd.net
steamstore-a.akamaihd.net
steamcommunity-a.akamaihd.net
steamcdn-a.akamaihd.net
steamuserimages-a.akamaihd.net
community.akamai.steamstatic.com
avatars.akamai.steamstatic.com
community.steamstatic.com
cdn.akamai.steamstatic.com
avatars.steamstatic.com
shared.akamai.steamstatic.com
clan.akamai.steamstatic.com
cdn.cloudflare.steamstatic.com
community.cloudflare.steamstatic.com
store.cloudflare.steamstatic.com
avatars.cloudflare.steamstatic.com
clan.cloudflare.steamstatic.com
shared.cloudflare.steamstatic.com
steam-chat.com
steamcloud-ugc.storage.googleapis.com
steamcloud-eu-ams.storage.googleapis.com
steamcloud-eu-fra.storage.googleapis.com
steamcloud-finland.storage.googleapis.com
steamcloud-saopaulo.storage.googleapis.com
steamcloud-singapore.storage.googleapis.com
steamcloud-sydney.storage.googleapis.com
steamcloud-taiwan.storage.googleapis.com
steamcloud-eu.storage.googleapis.com

geosite:category-games'

config shunt_rules 'AIGC'
        option remarks 'AIGC'
        option domain_list 'geosite:category-ai-!cn
geosite:apple-intelligence'

config shunt_rules 'Streaming'
        option remarks 'Streaming'
        option domain_list 'geosite:netflix
geosite:disney'

config shunt_rules 'Proxy'
        option remarks 'Proxy'
        option domain_list 'geosite:geolocation-!cn'
        option ip_list '149.154.160.0/20
91.108.4.0/22
91.108.56.0/24
109.239.140.0/24
67.198.55.0/24
8.8.4.4
8.8.8.8
208.67.222.222
208.67.220.220
1.1.1.1
1.1.1.2
1.0.0.1
9.9.9.9
149.112.112.112
2001:67c:4e8::/48
2001:b28:f23c::/48
2001:b28:f23d::/48
2001:b28:f23f::/48
2001:b28:f242::/48
2001:4860:4860::8888
2001:4860:4860::8844
2606:4700:4700::1111
2606:4700:4700::1001'

config shunt_rules 'Direct'
        option remarks 'Direct'
        option domain_list 'geosite:cn'
        option ip_list '223.5.5.5/32
223.6.6.6/32
119.29.29.29/32
180.76.76.76/32
114.114.114.114/32
114.114.115.115/32
1.12.12.12/32
120.53.53.53/32
geoip:cn
geoip:private'

config nodes 'Dah2TR22'
        option remarks '备注'
        option type 'Xray'
        option protocol 'trojan'
        option address '43.199.249.147'
        option port '57037'
        option password 'elrwin84p6'
        option tls '0'
        option transport 'raw'
        option tcp_guise 'none'
        option tcpMptcp '0'
        option tcpNoDelay '0'

config shunt_rules 'fenliutest'
        option remarks 'fenliutest'
        option network 'tcp,udp'
        option ip_list '0.0.0.0/0'
        option source '192.168.10.49'

config nodes 'UbdghGyO'
        option remarks 'test分流'
        option type 'Xray'
        option protocol '_shunt'
        option default_node '_direct'
        option domainStrategy 'IPOnDemand'
        option domainMatcher 'hybrid'
        option preproxy_enabled '1'
        option main_node 'QQfJTX6h'
        option fenliutest 'Dah2TR22'
        option fenliutest_proxy_tag 'main'
        option fenliu_yunji 'QQfJTX6h'
        option fenliu_test_ssh 'Dah2TR22'

config nodes 'QQfJTX6h'
        option tls '0'
        option type 'Xray'
        option timeout '60'
        option tcp_guise 'none'
        option security 'auto'
        option transport 'raw'
        option add_from '导入'
        option port '31121'
        option uuid '12ba3dab-b32c-4ebf-9a46-c00c93d86d25'
        option address '54.46.84.41'
        option remarks 'HK前置代理节点-test'
        option protocol 'vmess'
        option alter_id '0'
        option add_mode '1'
        option tcpMptcp '0'
        option tcpNoDelay '0'

config shunt_rules 'fenliu_yunji'
        option remarks 'fenliu_yunji'
        option network 'tcp,udp'
        option source '192.168.10.42 192.168.10.43 192.168.10.44 192.168.10.45 192.168.10.46 192.168.10.47 192.168.10.48 192.168.10.50 192.168.10.51 192.168.10.52 192.168.10.53 192.168.10.54 192.168.10.55 192.168.10.56 192.168.10.57 192.168.10.58 192.168.10.60 192.168.10.61 192.168.10.62 192.168.10.63 192.168.10.64 192.168.10.65 192.168.10.66 192.168.10.67 192.168.10.68 192.168.10.69 192.168.10.70 192.168.10.71 192.168.10.72 192.168.10.73 192.168.10.74'
        option ip_list '0.0.0.0/0'

config shunt_rules 'fenliu_test_ssh'
        option remarks 'fenliu_test_ssh'
        option network 'tcp,udp'
        option source '192.168.10.23'
        option ip_list '0.0.0.0/0'
```

以上是配置文件,不过需要关注并且实现的是

一机一网:

> **原理:**
>
> *就是通过给每个ip配置一个规则,通过规则去设置对应的节点*
>
> 首先往配置文件的底部加入
>
> ```text
> config shunt_rules 'fenliu_test_ssh' # 创建一条规则(规则名任意,但是必须)
>      option remarks 'fenliu_test_ssh' # 备注名(任意,但是必须)
>      option network 'tcp,udp' # 不要修改
>      option source '192.168.10.23' # 源IP,就是从什么机器出发的
>      option ip_list '0.0.0.0/0' # 目标IP,默认0.0.0.0/0,也就是全部IP
> ```
>
> 创建完成这个规则,找到`Xray`的分流配置
>
> ```text
> config nodes 'UbdghGyO'
>      option remarks 'test分流'
>      option type 'Xray'
>      option protocol '_shunt'
>      option default_node '_direct'
>      option domainStrategy 'IPOnDemand'
>      option domainMatcher 'hybrid'
>      option preproxy_enabled '1'
>      option main_node 'QQfJTX6h'
>      option fenliutest 'Dah2TR22'
>      option fenliutest_proxy_tag 'main'
>      option fenliu_yunji 'QQfJTX6h'
>      option fenliu_test_ssh 'Dah2TR22' # 这个就是给规则配置对应节点的
> ```
> 上面就是分流的配置文件
>
> 首先,由于是一机一网,首先需要有个订阅链接,可以获取到所有的socks代理
>
> 然后,比如对 上面的test的规则加入
>
> ```text
> option fenliu_test_ssh 'Dah2TR22' # 这个就是给规则配置对应节点的
> ```
>
> ```text
> option fenliutest_proxy_tag 'main' # 设置前置代理
> ```
>
> 直接vi这个配置文件即可生效

